---
title: "Trait Annotation Backbone"
author: "Oceana Tavasieff"
date: "9/10/2021"
output: html_document
---

Your input: -table of community data with abundance and grouped by tree
Your output: -two dataframes with trees as column names, relativized abundances by tree. Columns are either OTU's or trait-complexes. Output as .rds files
*Your notes below*
**Tejon data**
#SETUP
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
```

```{r read in FungalTraits doc}
short_traits <- read_xlsx("~/functional-fungi/FungalTraits 1.2_ver_16Dec_2020.xlsx") %>% rename(Genus = GENUS) 

ecm_short <- short_traits %>% drop_na(Ectomycorrhiza_exploration_type_template) %>% arrange(Genus)
#colnames(short_traits)
```

```{r Install Fun^Fun db which may have more consistent annotations}
# Version: https://zenodo.org/record/1216257

# Via: https://github.com/traitecoevo/fungaltraits

#install.packages("devtools")
#devtools::install_github("ropenscilabs/datastorr")
#devtools::install_github("traitecoevo/fungaltraits")
library(fungaltraits)
```

```{r Access Fun^Fun db, include=FALSE}
#fun_fun_db <-fungal_traits()
long_traits <- fungal_traits() %>% separate(speciesMatched, c("Genus", "Species", "Subspecies", "Etc"), " ")

# Add an exploration type column from the fungaltraits database 
exp_type_1 <- long_traits %>% select(Genus, Species, em_expl)
exp_type_2 <- short_traits %>% select(Genus, Ectomycorrhiza_exploration_type_template)


exp_type <- merge(exp_type_1, exp_type_2) %>% unite(EXP.TYPE, em_expl, Ectomycorrhiza_exploration_type_template, sep = "_", na.rm=T) 

fun_fun_traits <- colnames(fungal_traits())
 
```


#YOUR INPUT
-Community data
```{r}
tejon_metadata <- read.csv("TraitAnalysisforOceana/ecto_OTUs.csv") 
```
```{r}
tejon_traits <- read.csv("TraitAnalysisforOceana/ecto_OTU_traits.csv")
```
## Tejon Data Cleaning (Holly)

```{r tejon data cleaning}

tejon.trees <- read_csv('TraitAnalysisforOceana/fungal-abundance.csv') #OTU table
tejon.ecto <- read.csv('TraitAnalysisforOceana/ecto_OTUs.csv') #OTU's of only EcM
tejon.trees <- tejon.trees[tejon.trees$site!='intermediate',] #removes intermediate site from OTU table

tejon.trees.ecto <- select(tejon.trees,tree, site) %>% cbind(tejon.trees[,colnames(tejon.trees) %in% tejon.ecto$OTU_ID])%>% 
  mutate(.,enviro = site,
         site = rep("tejon", nrow(tejon.trees))) %>% 
  relocate(site, .before = tree) %>% 
  relocate(enviro, .after = tree)
write.csv(tejon.trees.ecto,'tejon_trees_ecto.csv')
#**might have to redo^ so arid = 1 and mesic = 3 --probablhy an ifelse command**

```

# Generate Trait Table (Holly)
```{r}
# Make a table that groups by traits, not OTUs

tejon.ecto.traits <-read.csv('TraitAnalysisforOceana/ecto_OTU_traits.csv')#trait + OTU, not a trait abundance matrix yet

tejon.ecto.traits$trait <- as.factor(tejon.ecto.traits$trait) # allows for levels cmd to work but may be a bad move?-addition by Oceana

#head(tejon.ecto.traits)
#levels(tejon.ecto.traits$trait) #[1] "exploration_type" "rhizomorphs"  

tejon.tree.traits <- tejon.trees.ecto %>% select(site, tree, enviro) %>% 
  mutate(short = 0,
         long = 0,
         medium = 0,
         norhizo = 0,
         rhizo = 0) 
  #subset out columns site, tree, enviro
short <- tejon.ecto.traits[tejon.ecto.traits$type=='short',]$OTU_ID
medium <- tejon.ecto.traits[tejon.ecto.traits$type=='medium',]$OTU_ID
long <- tejon.ecto.traits[tejon.ecto.traits$type=='long distance',]$OTU_ID
rhizo <- tejon.ecto.traits[tejon.ecto.traits$type=='r_true',]$OTU_ID
norhizo <- tejon.ecto.traits[tejon.ecto.traits$type=='r_false',]$OTU_ID

#holly then writes the proceeding function to test
```

# Function to Test if Fungus has a trait
```{r may want to write a different method}

#roughhh interp: this function pulls in abundance data per OTU per tree(id hope), relating trait w OTU using tejon.ecto.traits table
#Continue to try to find a tidyverse way to pull in the above lines and this for loop
for(i in 4:dim(tejon.trees.ecto)[2]){
	# for each fungus
	# determine whether it is a short-dist forager
	hold <- rep(0, dim(tejon.trees.ecto)[1])
	
	if(colnames(tejon.trees.ecto)[i] %in% short){
	  hold <- tejon.trees.ecto[,i]
	}
	
	tejon.tree.traits$short <- tejon.tree.traits$short + hold

	# determine whether it is a medium-dist forager
	hold <- rep(0, dim(tejon.trees.ecto)[1])
	if(colnames(tejon.trees.ecto)[i] %in% medium){ hold <- tejon.trees.ecto[,i] }
	tejon.tree.traits$medium <- tejon.tree.traits$medium + hold

	# determine whether it is a long-dist forager
	hold <- rep(0, dim(tejon.trees.ecto)[1])
	if(colnames(tejon.trees.ecto)[i] %in% long){ hold <- tejon.trees.ecto[,i] }
	tejon.tree.traits$long <- tejon.tree.traits$long + hold
	
	# determine whether it makes rhizomorphs
	hold <- rep(0, dim(tejon.trees.ecto)[1])
	if(colnames(tejon.trees.ecto)[i] %in% rhizo){ hold <- tejon.trees.ecto[,i] }
	tejon.tree.traits$rhizo <- tejon.tree.traits$rhizo + hold
		
	# determine whether it doesn't make rhizomorphs
	hold <- rep(0, dim(tejon.trees.ecto)[1])
	if(colnames(tejon.trees.ecto)[i] %in% norhizo){ hold <- tejon.trees.ecto[,i] }
	tejon.tree.traits$norhizo <- tejon.tree.traits$norhizo + hold
	
}

#for now this function is better than anything I can make
```

#Relativize TEJON tables
```{r}
#TEJON TRAITS

tejon_rel_traits <- tejon.tree.traits %>%
    mutate(sumAbund = select(., short:rhizo) %>% 
             rowSums(na.rm = TRUE)) %>% 
  transmute(tree = tree,
         short = short/sumAbund, 
         long = long/sumAbund, 
         medium = medium/sumAbund, 
         norhizo = norhizo/ sumAbund, 
         rhizo = rhizo/sumAbund) %>% 
  # group_by(tree) %>% 
  #summarise(short = sum(short),
   #        medium = sum(medium),
    #       long = sum(long),
     #      rhizo = sum(rhizo),
      #     norhizo = sum(norhizo)) %>% 
     column_to_rownames(., var = "tree")

#TEJON OTU

tejon_rel_OTU <- tejon.trees.ecto %>%
    mutate(sumAbund = select(., c(4:120,)) %>% 
             rowSums(na.rm = TRUE)) %>% 
  relocate(sumAbund, .after = enviro)

for(i in 5:ncol(tejon_rel_OTU)) {
 tejon_rel_OTU[,i] <- tejon_rel_OTU[,i]/tejon_rel_OTU$sumAbund
  }
tejon_rel_OTU <- tejon_rel_OTU %>% 
  mutate(sumAbund = select(., c(5:121,)) %>% 
             rowSums(na.rm = TRUE)) %>% 
  mutate(sumAbund = NULL,
         site = NULL,
         enviro = NULL)
tejon_rel_OTU <- column_to_rownames(tejon_rel_OTU, var = "tree")

tejon_tree_names <- unique(rownames(tejon.trees.ecto$tree))
```
#TEJON matrices
```{r}
tejon_OTU_matrix <- as.matrix(tejon_rel_OTU)
tejon_trait_matrix <- as.matrix(tejon_rel_traits)
```

```{r}
richard_raw <- Richard_et_al_OTU_table <- read_delim("Richard et al OTU table.csv", ";", escape_double = FALSE, trim_ws = TRUE)

```

```{r Generate OTU table}
rich_OTU <- richard_raw %>% select(Taxon, EA07:CS09) %>% mutate(Taxon = str_replace(Taxon, " ", "_")) %>% 
  column_to_rownames(var="Taxon") %>% 
  t %>% 
  as.data.frame %>% 
  rownames_to_column(var ="Taxon") %>% mutate(enviro = if_else(str_detect(Taxon, "E"), "arid", "mesic")) %>% relocate(enviro, .after = Taxon) 

rich_rel_OTU <- rich_OTU %>% mutate(sumAbund = select(., c(3:125,)) %>% 
             rowSums(na.rm = TRUE)) %>% 
  relocate(sumAbund, .after = enviro)

for(i in 4:ncol(rich_rel_OTU)) {
  rich_rel_OTU[,i] <- rich_rel_OTU[,i]/rich_rel_OTU$sumAbund
  }
rich_rel_OTU <- rich_rel_OTU %>% 
  mutate(sumAbund = select(., c(4:126,)) %>% 
             rowSums(na.rm = TRUE)) %>% 
  mutate(sumAbund = NULL,
         enviro = NULL)
rich_rel_OTU <- column_to_rownames(rich_rel_OTU, var = "Taxon")

saveRDS(rich_rel_OTU, "NMDS_4_input/richard_OTU_matrix.rds")

```

```{r Generate Trait Matrix}
rich_4tr <- richard_raw %>% select(-"GenBank accession number", -"Closest GenBank species", -"BLAST expected valueâ€¡") %>% separate(Taxon, c("Genus", "Species", "Etc"), " ")

richard_annotated <- left_join(rich_4tr, exp_type) %>% rename(Rhizomorph = "Rhizomorph-DEEMY") %>% unite(ID, Genus, Species, sep=" ") %>% 
  mutate(distance =  case_when(grepl("long", "Foraging_distance-DEEMY") ~ "long",
                               grepl("L", EXP.TYPE) ~ "long",grepl("medium", "Foraging_distance-DEEMY")~"medium",
                               grepl("medium", EXP.TYPE) ~ "medium",
                               grepl("M", EXP.TYPE) ~ "medium",
                               grepl("short", "Foraging_distance-DEEMY") ~ "short",
                               grepl("short", EXP.TYPE) ~ "short",
                               grepl("S", EXP.TYPE) ~ "short",
                               grepl("contact", EXP.TYPE) ~ "short",
                               grepl("C", EXP.TYPE)~"short"))%>% unique() #%>% select(-Etc, -"Foraging_distance-DEEMY", -EXP.TYPE, -Rhizomorph, distance) 
richard_annotated$distance <- replace_na(richard_annotated$distance, "unknown")
richard_annotated$Rhizomorph <- replace_na(richard_annotated$Rhizomorph, "unknown")

tr1 <- richard_annotated  %>% select(ID, Rhizomorph:CS09, distance) %>% group_by(distance, Rhizomorph) %>% summarise_at(vars(EA07:CS09), list(sum)) %>% ungroup() %>% 
  mutate(Rhizomorph = ifelse(Rhizomorph == "y", "rhizo", Rhizomorph),
         Rhizomorph = ifelse(Rhizomorph == "n", "norhizo", Rhizomorph)) %>% unite(Trait_species, distance, Rhizomorph, sep = "_" ) %>% mutate(Trait_species = as.character(.$Trait_species)) %>%  column_to_rownames("Trait_species") 

rich_rel_trait <- tr1 %>%   mutate(sumAbund = rowSums(across(where(is.numeric)))) %>%  mutate(across(everything()), . / sumAbund) %>% select(-sumAbund)


saveRDS(rich_rel_trait, "NMDS_4_input/richard_trait_matrix.rds")
```

